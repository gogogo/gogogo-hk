<style type="text/css">

.stoplisteditor {
    width:750px;
    height:350px"
}

.stoplisteditor .right_area {
    position: absolute; 
    left:610px;
    margin-top : 5px;
}

.stoplisteditor .header {
    margin-left: 40px;
}

.stoplisteditor .left_area {
    width:600px;
    height: 500px;
    margin-top: 1em;
    float:left
}

.stoplisteditor .error {
    color : red;
}

.stoplisteditor ul {
    margin-left: 0px;
}

.stoplisteditor li {
    list-style-type:None;
}

.stoplisteditor input {
    width : 650px;
}

.stoplisteditor a {
    margin-right : 5px;
}

</style>
<div  class="stoplisteditor">
<input {{final_attrs}} >

<div class="right_area"> 
    <div class="header">Stop list</div>

    <ul id="{{sortable_id}}" >
    </ul>
</div>

<div id="{{map_id}}" class="left_area"></div>

</div>

<script type="text/javascript">
	var {{map_id}};
	var {{model_manager}};
    var {{stop_manager}};
    var {{trip}};
    
    /// TODO: Create a StopListEditor javascript to replace the following functions
    
    function _createDeleteLink(parent) {
        var a = $("<a>[X]</a> ");
        a.click(function (){
           $(parent).remove();
           _stoplisteditorSortableChanged();
        });
        return a;
    }
    
    /// Called when the sortable object is changed
    function _stoplisteditorSortableChanged() {
        $("#{{id}}").val($("#{{sortable_id}}").sortable('toArray'));
        
        _stoplisteditorUpdateOverlay("#{{id}}","#{{sortable_id}}",{{trip}});        
    }

    /// update Sortable list of stop
    function _stoplisteditorUpdateSortable(input,sortable,trip) {
        var value = $(input).val();
        var keys = value.split(",");
        $(sortable).empty();
        for (var i = 0 ; i < keys.length;i++){
            //console.log(keys[i]);    
            
            var li = $("<li></li>");
            var a = _createDeleteLink($(li),input,sortable,trip);
            
            $(li).attr("id",keys[i]);
            $(li).append(a);
            $(li).append(keys[i]);
            
            $(sortable).append(li);
        }
        $(sortable).sortable("refresh");
    }

    /// update the map's overlay
    function _stoplisteditorUpdateOverlay(input,sortable,trip) {
        var value = $(input).val();
        var keys = value.split(",");
        
        var polyline = trip.getPolyline();
        if (polyline) {
            //console.log("removeOverlay");
            {{map_id}}.removeOverlay(polyline);
        }
        trip.removePolyline();

        trip.setStopIDList(keys);
        				
        trip.queryStops({{stop_manager}} , function(trip){
            var line = trip.createPolyline();
            {{map_id}}.addOverlay(line);
            trip.zoomAndPan({{map_id}});
            var kids = $(sortable).children();
            
            $.each(kids,function(i,child){
                var stop_list = trip.getStopList();
                var id = $(child).attr("id");
                
                for (var i = 0 ; i< stop_list.length;i++) {
                    var stop  = stop_list[i];
                    if (stop.getID() == id) {
                        if (!stop.error) {
                            var a = _createDeleteLink(child);
                            
                            $(child).empty();
                            $(child).append(a);
                            $(child).append(stop.getName());
                        } else {
                            $(child).addClass("error");
                        }
                        break;
                    }
                }
                
            });
        });
    }
		
	$(document).ready(function(){
        
			{{map_id}} = new GMap2(document.getElementById("{{map_id}}"));
			gogogo.mapSetup({{map_id}});
			{{model_manager}} = new gogogo.ModelManager();
            {{stop_manager}} = new gogogo.StopManager({{map_id}});
            {{trip}} = new gogogo.Trip();
            
            $("#{{sortable_id}}").sortable();
            
            $("#{{sortable_id}}").bind("sortstop",function (e,ui){
                _stoplisteditorSortableChanged();
            });            
            
            _stoplisteditorUpdateSortable("#{{id}}","#{{sortable_id}}",{{trip}});
            _stoplisteditorUpdateOverlay("#{{id}}","#{{sortable_id}}",{{trip}});
            
            $("#{{id}}").change(function(){
                _stoplisteditorUpdateSortable("#{{id}}","#{{sortable_id}}",{{trip}});
                _stoplisteditorUpdateOverlay("#{{id}}","#{{sortable_id}}",{{trip}});
            });
			
	});
</script>
